import pandas as pd

offers = pd.read_csv(r'filelocation\data_offers.csv')
orders = pd.read_csv(r'filelocation\data_orders.csv')

# cancelled orders
import plotly.express as px

data = orders.groupby(['order_status_key', 'is_driver_assigned_key'])['order_gk'].count().reset_index().rename(columns = {'order_gk':'order_count'})
data = data.replace(4, 'client cancellation')
data = data.replace(9, 'system cancellation')
data = data.replace(0, 'no driver assigned')
data = data.replace(1, 'driver assigned')

labels = data['order_status_key'] + ' with ' + data['is_driver_assigned_key']
values = data['order_count']
fig = px.pie(names = labels,
            values = values,
            title = 'Cancelled Orders per Driver Assignment')
fig.update_traces(textinfo = 'value',
                 textposition = 'inside')
fig.show()

data

# failed orders per hour
orders['order_datetime'] = pd.to_datetime(orders['order_datetime'])
orders['hour'] = orders['order_datetime'].dt.hour
per_hour = orders.groupby('hour')['order_gk'].count().reset_index().rename(columns = {'order_gk':'order_count'})

fig = px.line(per_hour,
             x = 'hour',
             y = 'order_count',
             title = 'Cancelled Orders per Hour')
fig.show()
per_hour

#Average time to Cancellation by the hour
data = orders[['is_driver_assigned_key', 'hour', 'cancellations_time_in_seconds']]
data = data.groupby(['is_driver_assigned_key', 'hour']).mean('cancellations_time_in_seconds').reset_index().rename(columns = {'cancellations_time_in_seconds':'average_time_to_cancellation(seconds)'})
data['is_driver_assigned_key'] = data['is_driver_assigned_key'].replace(0, 'no driver assigned')
data['is_driver_assigned_key'] = data['is_driver_assigned_key'].replace(1, 'driver assigned')
data['average_time_to_cancellation(seconds)'] = data['average_time_to_cancellation(seconds)'].round(2)
data

fig = px.line(data,
             x = 'hour',
             y = 'average_time_to_cancellation(seconds)',
             color = 'is_driver_assigned_key',
             title = 'Average Time to Cancellation (seconds) per Driver Assignment and Hour')
fig.show()
data

# average eta per hour

avg_eta = orders.groupby('hour')['m_order_eta'].mean().reset_index().rename(columns = {'m_order_eta':'average_eta'})
avg_eta['average_eta'] = avg_eta['average_eta'].round(2)

fig = px.line(avg_eta,
             x = 'hour',
             y = 'average_eta',
             title = 'Average ETA per Hour')

fig.show()
avg_eta
